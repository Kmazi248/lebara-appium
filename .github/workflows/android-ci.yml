name: Android CI (native)

on:
  push: { branches: [main] }
  pull_request: { branches: [main] }
  workflow_dispatch: {}

jobs:
  native:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }

      - name: Install deps
        run: npm ci

      - name: Boot emulator + run native smoke
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: pixel_5
          avd-name: Pixel_5
          force-avd-creation: true
          disable-animations: true
          emulator-boot-timeout: 1200
          emulator-options: >-
            -no-window -no-boot-anim -no-audio
            -camera-back none -camera-front none
            -gpu swiftshader_indirect -accel off
            -no-snapshot-load -no-snapshot-save
          script: |
            set -e
            # ADB can be flaky on cold boots; nudge it
            adb kill-server || true
            adb start-server
            adb devices

            # Ensure UiAutomator2 (idempotent)
            npx appium driver list --installed | grep -q uiautomator2 || npx appium driver install uiautomator2 || true

            # Start Appium and wait a bit
            npx appium --base-path /wd/hub --log-level warn & sleep 10

            # Try once; if it flakes, try again
            npx wdio run wdio.ci.conf.ts --spec test/specs/smoke.native.e2e.ts || {
              echo "Retrying smoke once after short waitâ€¦"
              sleep 8
              adb kill-server || true
              adb start-server
              npx wdio run wdio.ci.conf.ts --spec test/specs/smoke.native.e2e.ts
            }

      - name: Generate Allure (native)
        if: ${{ hashFiles('allure-results/**') != '' }}
        run: npx allure-commandline generate --clean ./allure-results -o ./allure-report

      - uses: actions/upload-artifact@v4
        if: ${{ hashFiles('allure-results/**') != '' }}
        with: { name: native-allure-results, path: allure-results }

      - uses: actions/upload-artifact@v4
        if: ${{ hashFiles('allure-report/**') != '' }}
        with: { name: native-allure-report, path: allure-report }
